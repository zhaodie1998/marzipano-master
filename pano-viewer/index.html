<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>全景图编辑器</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="favicon.svg" type="image/svg+xml">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2563eb">
  <meta name="description" content="专业的全景图查看和编辑工具">
</head>
<body>
  <!-- 顶部导航栏 -->
  <header class="top-nav">
    <div class="logo">
      <svg viewBox="0 0 24 24" width="28" height="28" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
      <h1>全景编辑器</h1>
    </div>
    <div class="nav-actions">
      <button class="btn btn-primary" id="saveBtn"><span class="icon">💾</span> 保存</button>
    </div>
  </header>

  <!-- 主容器 -->
  <div class="main-container">
    
    <!-- 左侧场景列表 (默认收起) -->
    <aside class="sidebar collapsed" id="sidebar">
      <div class="sidebar-header">
        <h2>场景列表</h2>
        <button class="btn-icon" id="addSceneBtn" title="添加场景">
          <span>➕</span>
        </button>
      </div>
      
      <!-- 上传区域 -->
      <div class="upload-area" id="uploadArea">
        <input type="file" id="fileInput" accept="image/*" multiple style="display: none;">
        <div class="upload-content">
          <div class="upload-icon">📁</div>
          <p class="upload-text">点击或拖拽上传全景图</p>
          <p class="upload-hint">支持JPG、PNG格式<br>建议分辨率：4096x2048以上</p>
        </div>
      </div>

      <!-- 场景列表容器 -->
      <div class="scene-list" id="sceneList">
        <div class="empty-state">
          <p>暂无场景</p>
          <p class="hint">上传全景图开始创建</p>
        </div>
      </div>
      <div class="sidebar-resizer" id="sidebarResizer"></div>
    </aside>

    <div id="sidebarToggle" class="sidebar-toggle" title="展开/收起侧栏" style="padding-bottom: env(safe-area-inset-bottom); padding-top: env(safe-area-inset-top);">
      <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
    </div>

    <!-- 中间全景查看器 -->
    <main class="viewer-container">
      <div id="pano" class="pano-viewer"></div>
      
      <!-- 空状态提示 -->
      <div class="empty-viewer" id="emptyViewer">
        <div class="empty-content">
          <div class="empty-icon">🌍</div>
          <h2>开始创建您的全景作品</h2>
          <p>上传全景图片，创建沉浸式体验</p>
          <button class="btn btn-large btn-primary" id="uploadTrigger">
            <span class="icon">⬆️</span> 上传全景图
          </button>
        </div>
      </div>

      <!-- 底部控制栏 -->
      <div class="control-bar-container">
        <!-- 场景标题遮罩 (移动到底部左侧) -->
        <div class="scene-title-overlay" id="sceneTitleOverlay">
          <h2 id="overlaySceneName">场景名称</h2>
          <p id="overlaySceneCount">1 / 1</p>
        </div>

        <div class="control-bar" id="controlBar" style="display: none;">
          <!-- 隐藏的音频元素 -->
          <audio id="bgMusic" loop style="display: none;"></audio>
          
          <div class="control-group">
            <button class="control-btn" id="bottomAutoRotateBtn" title="自动旋转">
          <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46A7.93 7.93 0 0 0 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74A7.93 7.93 0 0 0 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/></svg>
        </button>
        <button class="control-btn" id="bottomFullscreenBtn" title="全屏">
          <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
        </button>
        <button class="control-btn" id="bottomCompassBtn" title="指南针">
          <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5.5-2.5l7.51-3.49L17.5 6.5 9.99 9.99 6.5 17.5zm5.5-6.6c.61 0 1.1.49 1.1 1.1s-.49 1.1-1.1 1.1-1.1-.49-1.1-1.1.49-1.1 1.1-1.1z"/></svg>
        </button>
        <button class="control-btn" id="gyroBtn" title="陀螺仪">
          <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M7 17h10q.425 0 .713-.288T18 16v-6q0-.425-.288-.713T17 9H7q-.425 0-.713.288T6 10v6q0 .425.288.713T7 17Zm-2 2q-.825 0-1.413-.588T3 17V7q0-.825.588-1.413T5 5h14q.825 0 1.413.588T21 7v12q0 .825-.588 1.413T19 19H5Zm0-2h14V7H5v10Zm7-5Z"/></svg>
        </button>
      </div>
        
        <div class="control-group scene-info">
          <button class="control-btn" id="prevSceneBtn" title="上一个场景">
            <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
          </button>
          <span id="currentSceneName">场景名称</span>
          <button class="control-btn" id="nextSceneBtn" title="下一个场景">
            <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
          </button>
        </div>

        <div class="control-group">
          <button class="control-btn" id="bottomAddHotspotBtn" title="添加热点">
            <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/></svg>
          </button>
          <button class="control-btn" id="bottomAddMusicBtn" title="添加音乐">
            <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/></svg>
          </button>
          <button class="control-btn" id="bottomAddTextBtn" title="添加文字">
            <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M2.5 4v3h5v12h3V7h5V4h-13zm19 5h-9v3h3v7h3v-7h3V9z"/></svg>
          </button>
          <button class="control-btn" id="bottomScreenshotBtn" title="截图">
            <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
          </button>
          <button class="control-btn" id="toggleHotspotsBtn" title="显示/隐藏热点">
            <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
          </button>
          <button class="control-btn" id="minimapBtn" title="场景小地图">
            <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36 .25-.36 .48V20.5c0 .28 .22 .5 .5 .5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07 .36-.25 .36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/></svg>
          </button>
          <button class="control-btn" id="settingsBtn" title="设置">
            <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43 .17-.47 .41l-.36 2.54c-.59 .24-1.13 .57-1.62 .94l-2.39-.96c-.22-.08-.47 0-.59 .22L5.09 8.87c-.12 .21-.08 .47 .12 .61l2.03 1.58c-.05 .3-.09 .63-.09 .94s.02 .64 .07 .94l-2.03 1.58c-.18 .14-.23 .41-.12 .61l1.92 3.32c.12 .22 .37 .29 .59 .22l2.39-.96c.5 .38 1.03 .7 1.62 .94l.36 2.54c.04 .24 .24 .41 .48 .41h3.84c.24 0 .43-.17 .47-.41l.36-2.54c.59-.24 1.13-.57 1.62-.94l2.39 .96c.22 .08 .47 0 .59-.22l1.92-3.32c.12-.22 .07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
          </button>
          <button class="control-btn" id="bottomMoreBtn" title="更多">
            <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M12 8a2 2 0 110-4 2 2 0 010 4zm0 6a2 2 0 110-4 2 2 0 010 4zm0 6a2 2 0 110-4 2 2 0 010 4z"/></svg>
          </button>
        </div>
      </div>
      <div id="sceneDock" class="scene-dock hidden"></div>
      <div id="sceneDockToggle" class="scene-dock-toggle" title="显示/隐藏场景预览">▲</div>
    </main>

    <!-- 右侧属性面板 -->
    <aside class="properties-panel" id="propertiesPanel">
      <div class="panel-header">
        <h3>属性</h3>
        <button class="btn-icon" id="closePanelBtn">✕</button>
      </div>
      
      <div class="panel-content">
        <div class="property-section">
          <h4>场景设置</h4>
          <div class="property-item">
            <label>场景名称</label>
            <input type="text" id="sceneNameInput" class="input" placeholder="输入场景名称">
          </div>
          <div class="property-item">
            <label>初始视角</label>
            <div class="property-row">
              <input type="number" id="yawInput" class="input-small" placeholder="水平角">
              <input type="number" id="pitchInput" class="input-small" placeholder="俯仰角">
            </div>
          </div>
          <div class="property-item">
            <label>曝光</label>
            <input type="range" id="exposureInput" min="0.2" max="4" step="0.1" value="1">
          </div>
          <div class="property-item">
            <label>色调映射</label>
            <select id="toneMappingSelect" class="input">
              <option value="ACES">ACES Filmic</option>
              <option value="Reinhard">Reinhard</option>
              <option value="Linear">Linear</option>
            </select>
          </div>
          <div class="property-item">
            <button class="btn" id="resetHDRBtn">重置HDR设置</button>
          </div>
        </div>

        <div class="property-section">
          <h4>热点管理</h4>
          <div id="hotspotList" class="hotspot-list">
            <p class="hint">暂无热点，点击"添加热点"创建</p>
          </div>
        </div>
      </div>
      <div class="panel-resizer" id="panelResizer"></div>
    </aside>
  </div>

  <!-- 加载提示 -->
  <div class="loading-overlay" id="loadingOverlay" style="display: none;">
    <div class="loading-content">
      <div class="spinner"></div>
      <p id="loadingText">处理中...</p>
      <div class="progress-bar" id="progressBar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
    </div>
  </div>

  <!-- 热点创建模态框 -->
  <div class="modal" id="hotspotModal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>创建热点</h3>
        <button class="btn-icon" id="closeModalBtn">✕</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>热点类型</label>
          <select id="hotspotType" class="input">
            <option value="info">信息热点</option>
            <option value="link">场景链接</option>
            <option value="image">图片热点</option>
          </select>
        </div>
        <div class="form-group">
          <label>热点标题</label>
          <input type="text" id="hotspotTitle" class="input" placeholder="输入标题">
        </div>
        <div class="form-group" id="hotspotContentGroup">
          <label>热点内容</label>
          <textarea id="hotspotContent" class="input textarea" placeholder="输入内容"></textarea>
        </div>
        <div class="form-group" id="hotspotLinkGroup" style="display: none;">
          <label>链接到场景</label>
          <select id="hotspotLinkScene" class="input">
            <option value="">选择场景</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelHotspotBtn">取消</button>
        <button class="btn btn-primary" id="confirmHotspotBtn">确定</button>
      </div>
    </div>
  </div>


  <!-- 场景小地图 -->
  <div id="minimap" class="minimap" style="display: none;"></div>

  <script src="exr-decoder.js"></script>

  <!-- Marzipano 库 -->
  <script src="marzipano.js"></script>
  
  <!-- API 客户端 (Web 服务端模式) -->
  <script src="api-client.js"></script>
  
  <!-- 主应用 -->
  <script src="page-viewer.js"></script>
  <script src="app-main.js"></script>
</body>
</html>
