<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>å…¨æ™¯ç¼–è¾‘å™¨ - é¡¹ç›®ç®¡ç†</title>
  <link rel="icon" href="favicon.svg" type="image/svg+xml">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      min-height: 100vh;
      color: white;
      padding: 20px;
      padding-bottom: env(safe-area-inset-bottom, 20px);
    }
    
    .container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 16px;
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .header h1 {
      font-size: 22px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .logo-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, #38bdf8 0%, #818cf8 100%);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
    
    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .user-info {
      font-size: 13px;
      color: rgba(255,255,255,0.6);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn {
      padding: 10px 20px;
      border-radius: 10px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #38bdf8 0%, #818cf8 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(56, 189, 248, 0.3);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(56, 189, 248, 0.4);
    }
    
    .btn-secondary {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.15);
      color: rgba(255,255,255,0.8);
    }
    
    .btn-secondary:hover {
      background: rgba(255,255,255,0.15);
    }
    
    .btn-logout {
      background: transparent;
      color: rgba(255,255,255,0.5);
      padding: 8px 12px;
    }
    
    .btn-logout:hover {
      color: #f87171;
    }
    
    /* é¡¹ç›®ç½‘æ ¼ */
    .project-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }
    
    .project-card {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.25s ease;
      position: relative;
    }
    
    .project-card:hover {
      background: rgba(255,255,255,0.08);
      transform: translateY(-4px);
      border-color: rgba(56, 189, 248, 0.5);
      box-shadow: 0 12px 32px rgba(0,0,0,0.3);
    }
    
    .project-card:active {
      transform: translateY(-2px);
    }
    
    .project-thumb {
      width: 100%;
      aspect-ratio: 16/9;
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      object-fit: cover;
      display: block;
    }
    
    .project-info {
      padding: 16px;
    }
    
    .project-info h3 {
      font-size: 15px;
      font-weight: 600;
      margin: 0 0 8px 0;
      color: rgba(255,255,255,0.95);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .project-meta {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: rgba(255,255,255,0.5);
    }
    
    .delete-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(0,0,0,0.6);
      color: white;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: all 0.2s;
      cursor: pointer;
      font-size: 14px;
    }
    
    .project-card:hover .delete-btn { opacity: 1; }
    .delete-btn:hover { background: #ef4444; transform: scale(1.1); }
    
    /* æ–°å»ºé¡¹ç›®å¡ç‰‡ */
    .new-project-card {
      background: rgba(56, 189, 248, 0.1);
      border: 2px dashed rgba(56, 189, 248, 0.3);
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 200px;
      cursor: pointer;
      transition: all 0.25s ease;
    }
    
    .new-project-card:hover {
      background: rgba(56, 189, 248, 0.15);
      border-color: rgba(56, 189, 248, 0.5);
      transform: translateY(-4px);
    }
    
    .new-project-card .icon {
      width: 56px;
      height: 56px;
      background: rgba(56, 189, 248, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      margin-bottom: 12px;
    }
    
    .new-project-card span {
      font-size: 14px;
      color: rgba(255,255,255,0.7);
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: rgba(255,255,255,0.4);
      grid-column: 1 / -1;
    }
    
    .empty-state .icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    
    /* Modal */
    .modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.75);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    
    .modal.show { display: flex; }
    
    .modal-box {
      background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
      padding: 28px;
      border-radius: 20px;
      width: 100%;
      max-width: 420px;
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 24px 48px rgba(0,0,0,0.5);
      animation: modalIn 0.3s ease;
    }
    
    @keyframes modalIn {
      from { opacity: 0; transform: scale(0.95) translateY(10px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }
    
    .modal-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
    }
    
    .modal-header .icon {
      width: 44px;
      height: 44px;
      background: linear-gradient(135deg, #38bdf8 0%, #818cf8 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
    }
    
    .modal-header h2 {
      font-size: 18px;
      font-weight: 600;
    }
    
    .modal-header p {
      font-size: 13px;
      color: rgba(255,255,255,0.5);
      margin-top: 4px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      font-size: 13px;
      color: rgba(255,255,255,0.6);
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .form-group input {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 12px;
      background: rgba(0,0,0,0.3);
      color: white;
      font-size: 15px;
      transition: all 0.2s;
    }
    
    .form-group input::placeholder {
      color: rgba(255,255,255,0.3);
    }
    
    .form-group input:focus {
      outline: none;
      border-color: #38bdf8;
      box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.2);
      background: rgba(0,0,0,0.4);
    }
    
    .form-hint {
      font-size: 12px;
      color: rgba(255,255,255,0.4);
      margin-top: 8px;
    }
    
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 24px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: rgba(255,255,255,0.6);
    }
    
    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid rgba(255,255,255,0.1);
      border-top-color: #38bdf8;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 12px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* ç§»åŠ¨ç«¯é€‚é… */
    @media (max-width: 640px) {
      body {
        padding: 16px;
      }
      
      .header {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }
      
      .header-left {
        justify-content: center;
      }
      
      .header-actions {
        justify-content: center;
      }
      
      .header h1 {
        font-size: 18px;
      }
      
      .project-grid {
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 16px;
      }
      
      .delete-btn {
        opacity: 1;
        width: 28px;
        height: 28px;
      }
      
      .modal-box {
        padding: 24px 20px;
      }
      
      .btn {
        padding: 12px 20px;
      }
    }
    
    /* è§¦æ‘¸è®¾å¤‡ä¼˜åŒ– */
    @media (hover: none) {
      .delete-btn {
        opacity: 1;
      }
      
      .project-card:hover {
        transform: none;
      }
      
      .project-card:active {
        transform: scale(0.98);
      }
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <div class="header-left">
      <h1>
        <div class="logo-icon">ğŸŒ</div>
        å…¨æ™¯ç¼–è¾‘å™¨
      </h1>
    </div>
    <div class="header-actions">
      <span class="user-info" id="userInfo"></span>
      <button class="btn btn-primary" onclick="showCreateModal()">
        <span>+</span> æ–°å»ºé¡¹ç›®
      </button>
      <button class="btn btn-logout" onclick="logout()" title="é€€å‡ºç™»å½•">é€€å‡º</button>
    </div>
  </div>
  
  <div class="project-grid" id="projectGrid">
    <div class="loading">
      <div class="loading-spinner"></div>
      åŠ è½½ä¸­...
    </div>
  </div>
</div>

<!-- Create Modal -->
<div class="modal" id="createModal">
  <div class="modal-box">
    <div class="modal-header">
      <div class="icon">ğŸ“</div>
      <div>
        <h2>åˆ›å»ºæ–°é¡¹ç›®</h2>
        <p>å¼€å§‹åˆ›å»ºæ‚¨çš„å…¨æ™¯æ¼«æ¸¸</p>
      </div>
    </div>
    <div class="form-group">
      <label for="projectName">é¡¹ç›®åç§°</label>
      <input type="text" id="projectName" placeholder="ä¾‹å¦‚ï¼šå±•å…å…¨æ™¯ã€æ ·æ¿é—´æ¼«æ¸¸" maxlength="50" autocomplete="off">
      <div class="form-hint">æ”¯æŒä¸­æ–‡ã€è‹±æ–‡ã€æ•°å­—ï¼Œæœ€å¤š50ä¸ªå­—ç¬¦</div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="hideCreateModal()">å–æ¶ˆ</button>
      <button class="btn btn-primary" id="createBtn" onclick="createProject()">åˆ›å»ºé¡¹ç›®</button>
    </div>
  </div>
</div>

<script src="api-client.js"></script>
<script>
  // æ£€æŸ¥ç™»å½•çŠ¶æ€
  (function() {
    const token = localStorage.getItem('auth_token');
    const userName = localStorage.getItem('user_name');
    
    // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
    const userInfo = document.getElementById('userInfo');
    if (userName) {
      userInfo.textContent = `ğŸ‘¤ ${userName}`;
    }
  })();
  
  function logout() {
    if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
      localStorage.removeItem('auth_token');
      localStorage.removeItem('user_name');
      localStorage.removeItem('last_project_id');
      window.location.href = 'login.html';
    }
  }

  // åŠ è½½é¡¹ç›®åˆ—è¡¨
  async function loadProjects() {
    const grid = document.getElementById('projectGrid');
    
    try {
      const projects = await apiClient.getProjects();
      
      // å§‹ç»ˆæ˜¾ç¤ºæ–°å»ºé¡¹ç›®å¡ç‰‡
      let html = `
        <div class="new-project-card" onclick="showCreateModal()">
          <div class="icon">â•</div>
          <span>æ–°å»ºé¡¹ç›®</span>
        </div>
      `;
      
      if (projects.length === 0) {
        html += `
          <div class="empty-state">
            <div class="icon">ğŸ“</div>
            <p>æš‚æ— é¡¹ç›®</p>
            <p style="margin-top:8px;font-size:13px;">ç‚¹å‡»ã€Œæ–°å»ºé¡¹ç›®ã€å¼€å§‹åˆ›ä½œ</p>
          </div>
        `;
      } else {
        html += projects.map(p => `
          <div class="project-card" onclick="openProject('${p.id}')">
            <button class="delete-btn" onclick="deleteProject(event, '${p.id}')" title="åˆ é™¤é¡¹ç›®">âœ•</button>
            <img src="${p.thumbnail || 'favicon.svg'}" class="project-thumb" onerror="this.src='favicon.svg'" alt="${escapeHtml(p.name)}">
            <div class="project-info">
              <h3 title="${escapeHtml(p.name)}">${escapeHtml(p.name)}</h3>
              <div class="project-meta">
                <span>${p.sceneCount || 0} ä¸ªåœºæ™¯</span>
                <span>${formatDate(p.lastModified)}</span>
              </div>
            </div>
          </div>
        `).join('');
      }
      
      grid.innerHTML = html;
    } catch (e) {
      console.error('åŠ è½½é¡¹ç›®å¤±è´¥:', e);
      
      // æ£€æŸ¥æ˜¯å¦æ˜¯è®¤è¯é”™è¯¯
      if (e.message && e.message.includes('401')) {
        grid.innerHTML = `
          <div class="empty-state">
            <div class="icon">ğŸ”’</div>
            <p>ç™»å½•å·²è¿‡æœŸ</p>
            <p style="margin-top:12px;">
              <button class="btn btn-primary" onclick="window.location.href='login.html'">é‡æ–°ç™»å½•</button>
            </p>
          </div>
        `;
      } else {
        grid.innerHTML = `
          <div class="empty-state">
            <div class="icon">âŒ</div>
            <p>åŠ è½½å¤±è´¥</p>
            <p style="margin-top:8px;font-size:13px;">${escapeHtml(e.message || 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥')}</p>
            <p style="margin-top:12px;">
              <button class="btn btn-secondary" onclick="loadProjects()">é‡è¯•</button>
            </p>
          </div>
        `;
      }
    }
  }

  function escapeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function formatDate(timestamp) {
    if (!timestamp) return '';
    const date = new Date(timestamp);
    const now = new Date();
    const diff = now - date;
    
    // ä»Šå¤©
    if (diff < 24 * 60 * 60 * 1000 && date.getDate() === now.getDate()) {
      return 'ä»Šå¤© ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
    }
    
    // æ˜¨å¤©
    const yesterday = new Date(now);
    yesterday.setDate(yesterday.getDate() - 1);
    if (date.getDate() === yesterday.getDate() && date.getMonth() === yesterday.getMonth()) {
      return 'æ˜¨å¤©';
    }
    
    // ä¸€å‘¨å†…
    if (diff < 7 * 24 * 60 * 60 * 1000) {
      const days = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
      return days[date.getDay()];
    }
    
    return date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
  }

  window.showCreateModal = function() {
    document.getElementById('createModal').classList.add('show');
    const input = document.getElementById('projectName');
    input.value = '';
    setTimeout(() => input.focus(), 100);
  };

  window.hideCreateModal = function() {
    document.getElementById('createModal').classList.remove('show');
  };

  window.createProject = async function() {
    const input = document.getElementById('projectName');
    const name = input.value.trim();
    const btn = document.getElementById('createBtn');
    
    if (!name) {
      input.focus();
      input.style.borderColor = '#f87171';
      setTimeout(() => input.style.borderColor = '', 2000);
      return;
    }
    
    // éªŒè¯åç§°
    if (/[<>:"/\\|?*]/.test(name)) {
      alert('é¡¹ç›®åç§°ä¸èƒ½åŒ…å«ç‰¹æ®Šå­—ç¬¦: < > : " / \\ | ? *');
      return;
    }
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    btn.disabled = true;
    btn.innerHTML = '<span class="loading-spinner" style="width:16px;height:16px;border-width:2px;margin:0"></span> åˆ›å»ºä¸­...';
    
    try {
      const result = await apiClient.createProject(name);
      if (result.success) {
        hideCreateModal();
        // ä¿å­˜æœ€åæ‰“å¼€çš„é¡¹ç›®
        localStorage.setItem('last_project_id', result.project.id);
        window.location.href = `index.html?project=${result.project.id}`;
      }
    } catch (e) {
      alert('åˆ›å»ºå¤±è´¥: ' + (e.message || 'æœªçŸ¥é”™è¯¯'));
      btn.disabled = false;
      btn.innerHTML = 'åˆ›å»ºé¡¹ç›®';
    }
  };

  window.openProject = function(projectId) {
    localStorage.setItem('last_project_id', projectId);
    window.location.href = `index.html?project=${projectId}`;
  };

  window.deleteProject = async function(e, projectId) {
    e.stopPropagation();
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¡¹ç›®å—ï¼Ÿ\n\nâš ï¸ æ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œæ‰€æœ‰åœºæ™¯å’Œæ•°æ®å°†è¢«æ°¸ä¹…åˆ é™¤ã€‚')) return;
    
    try {
      await apiClient.deleteProject(projectId);
      // å¦‚æœåˆ é™¤çš„æ˜¯æœ€åæ‰“å¼€çš„é¡¹ç›®ï¼Œæ¸…é™¤è®°å½•
      if (localStorage.getItem('last_project_id') === projectId) {
        localStorage.removeItem('last_project_id');
      }
      loadProjects();
    } catch (e) {
      alert('åˆ é™¤å¤±è´¥: ' + (e.message || 'æœªçŸ¥é”™è¯¯'));
    }
  };

  // é”®ç›˜äº‹ä»¶
  document.getElementById('projectName').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      window.createProject();
    }
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') hideCreateModal();
    // Ctrl/Cmd + N æ–°å»ºé¡¹ç›®
    if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
      e.preventDefault();
      showCreateModal();
    }
  });

  document.getElementById('createModal').addEventListener('click', (e) => {
    if (e.target.id === 'createModal') hideCreateModal();
  });

  // åˆå§‹åŒ–
  loadProjects();
</script>

</body>
</html>
